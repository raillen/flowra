import React, { useState, useEffect, useRef } from 'react';
import { 
  Layout, List, CalendarRange, ChevronRight, LayoutDashboard, 
  MessageSquare, Settings, Plus, Folder, ArrowLeft, MoreVertical, 
  Users, Search, Star, Box, CheckSquare, Clock, AlertCircle, X,
  GripVertical, Edit2, Trash2, Save, Paperclip, Link as LinkIcon,
  AlignLeft, User, Calendar as CalendarIcon, CheckCircle2, Circle,
  Mail, Briefcase, Bell, LogOut, Camera, ArrowRightLeft, StickyNote, FileText,
  Menu, FolderPlus, MoveRight, UserCheck, Palette, GripHorizontal, ChevronDown,
  Building, Layers, Tag, Upload, Database, RefreshCw, FileSpreadsheet, Globe, MapPin, Eye, Phone, UserCircle
} from 'lucide-react';

// --- COMPONENTES UI BÁSICOS ---

const Badge = ({ children, color = "bg-slate-100 text-slate-600" }) => (
  <span className={`px-2 py-0.5 rounded text-xs font-bold ${color} border border-black/5`}>
    {children}
  </span>
);

const Button = ({ children, onClick, variant = "primary", className = "", icon: Icon, disabled = false }) => {
  const baseStyle = "px-4 py-2 rounded-lg font-medium transition-all flex items-center justify-center gap-2 active:scale-95 text-sm disabled:opacity-50 disabled:cursor-not-allowed";
  const variants = {
    primary: "bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm hover:shadow",
    secondary: "bg-white text-slate-700 border border-slate-200 hover:bg-slate-50",
    ghost: "text-slate-500 hover:bg-slate-100 hover:text-slate-700",
    danger: "bg-red-50 text-red-600 hover:bg-red-100"
  };
  
  return (
    <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`}>
      {Icon && <Icon size={16} />}
      {children}
    </button>
  );
};

const Modal = ({ isOpen, onClose, title, children, maxWidth = "max-w-md" }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 backdrop-blur-sm p-4 overflow-y-auto">
      <div className={`bg-white rounded-xl shadow-2xl w-full ${maxWidth} overflow-hidden flex flex-col max-h-[90vh]`}>
        <div className="flex justify-between items-center p-4 border-b border-slate-100 bg-slate-50 shrink-0">
          <h3 className="font-bold text-lg text-slate-800">{title}</h3>
          <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full transition-colors">
            <X size={20} className="text-slate-500" />
          </button>
        </div>
        <div className="flex-1 overflow-y-auto custom-scrollbar p-6 bg-white">
          {children}
        </div>
      </div>
    </div>
  );
};

// --- DADOS INICIAIS (MOCK) ---

const initialCompanies = [
  { 
    id: 'comp_1', 
    name: 'Rede Montagens Ltda', 
    cnpj: '12.345.678/0001-90', 
    legalName: 'Rede Montagens e Serviços Ltda', 
    city: 'São Paulo', 
    state: 'SP',
    segment: 'Manutenção Industrial',
    contactName: 'Carlos Silva',
    contactEmail: 'carlos@redemontagens.com.br',
    contactPhone: '(11) 98765-4321'
  },
  { 
    id: 'comp_2', 
    name: 'Tech Inovação', 
    cnpj: '98.765.432/0001-10', 
    legalName: 'Tech Inovação S.A.', 
    city: 'Curitiba', 
    state: 'PR',
    segment: 'Tecnologia da Informação',
    contactName: 'Mariana Souza',
    contactEmail: 'mariana@techinovacao.com',
    contactPhone: '(41) 3333-4444'
  }
];

const initialGroups = [
  { id: 'grp_1', name: 'Marketing' },
  { id: 'grp_2', name: 'RH' },
  { id: 'grp_3', name: 'Engenharia' },
  { id: 'grp_4', name: 'Financeiro' }
];

const initialCollaborators = [
  { 
    id: 'col_1', 
    employeeId: '1001',
    pis: '123.45678.90-0',
    name: 'Juquinha da Silva', 
    email: 'juquinha@rede.com', 
    status: 'Ativo',
    companyIds: ['comp_1'], 
    groupIds: ['grp_1', 'grp_2'] 
  },
  { 
    id: 'col_2', 
    employeeId: '1002',
    pis: '987.65432.10-0',
    name: 'Maria Tech', 
    email: 'maria@tech.com', 
    status: 'Ativo',
    companyIds: ['comp_2'], 
    groupIds: ['grp_3'] 
  }
];

const initialData = [
  {
    id: 'proj_1',
    name: 'Campanha Black Friday',
    department: 'Marketing',
    companyId: 'comp_1', 
    groupId: 'grp_1',    
    description: 'Planejamento e execução das mídias para novembro.',
    owner: 'Eu',
    members: ['Ana', 'Carlos', 'Beatriz'],
    docs: [
      { id: 'd1', title: 'Briefing da Campanha', content: 'Objetivo: Aumentar vendas em 20%.' }
    ],
    notes: [
      { id: 'n1', text: 'Lembrar de aprovar o orçamento!', color: 'bg-yellow-200', x: 50, y: 50 }
    ],
    boards: [
      {
        id: 'board_1',
        name: 'Criação de Artes',
        columns: [
          { id: 'c1', title: 'Briefing', color: 'bg-slate-100' },
          { id: 'c2', title: 'Em Design', color: 'bg-blue-50' },
          { id: 'c3', title: 'Aprovado', color: 'bg-green-50' }
        ],
        cards: [
          { id: 't1', columnId: 'c1', title: 'Banner Instagram', priority: 'alta', tags: ['Social'], dueDate: '2023-11-15' }
        ]
      }
    ],
    chat: []
  }
];

const initialUser = {
  name: 'Administrador',
  email: 'admin@sistema.com',
  role: 'Super Admin',
  department: 'Gestão',
  joinDate: '2023-01-15'
};

// --- COMPONENTE PRINCIPAL DO SISTEMA ---

export default function ProjectSystem() {
  // Estado Global de Projetos
  const [projects, setProjects] = useState(() => {
    const saved = localStorage.getItem('hierarchy-projects');
    return saved ? JSON.parse(saved) : initialData;
  });

  // Estado Global Administrativo
  const [companies, setCompanies] = useState(() => {
    const saved = localStorage.getItem('adm-companies');
    return saved ? JSON.parse(saved) : initialCompanies;
  });

  const [groups, setGroups] = useState(() => {
    const saved = localStorage.getItem('adm-groups');
    return saved ? JSON.parse(saved) : initialGroups;
  });

  const [collaborators, setCollaborators] = useState(() => {
    const saved = localStorage.getItem('adm-collaborators');
    return saved ? JSON.parse(saved) : initialCollaborators;
  });

  const [user, setUser] = useState(() => {
    const saved = localStorage.getItem('user-profile');
    return saved ? JSON.parse(saved) : initialUser;
  });

  // Navegação
  const [activeProjectId, setActiveProjectId] = useState(null); 
  const [activeModule, setActiveModule] = useState('projects'); 
  const [activeBoardId, setActiveBoardId] = useState(null);

  // Estados de Modais
  const [isProjectModalOpen, setIsProjectModalOpen] = useState(false);
  const [isBoardModalOpen, setIsBoardModalOpen] = useState(false);
  
  // Estado para criação de Projetos
  const [newProjectName, setNewProjectName] = useState('');
  const [newProjectCompany, setNewProjectCompany] = useState('');
  const [newProjectGroup, setNewProjectGroup] = useState('');
  
  // Estado para criação de Board
  const [newBoardName, setNewBoardName] = useState('');
  const [selectedProjectForBoard, setSelectedProjectForBoard] = useState('');

  // Persistência
  useEffect(() => { localStorage.setItem('hierarchy-projects', JSON.stringify(projects)); }, [projects]);
  useEffect(() => { localStorage.setItem('user-profile', JSON.stringify(user)); }, [user]);
  useEffect(() => { localStorage.setItem('adm-companies', JSON.stringify(companies)); }, [companies]);
  useEffect(() => { localStorage.setItem('adm-groups', JSON.stringify(groups)); }, [groups]);
  useEffect(() => { localStorage.setItem('adm-collaborators', JSON.stringify(collaborators)); }, [collaborators]);

  // --- NAVEGAÇÃO HELPERS ---

  const activeProject = projects.find(p => p.id === activeProjectId);
  const activeBoard = activeProject?.boards.find(b => b.id === activeBoardId);

  const navigateTo = (module) => {
    setActiveModule(module);
    setActiveBoardId(null);
  };

  const selectProject = (id) => {
    setActiveProjectId(id);
    setActiveModule('dashboard'); 
    setActiveBoardId(null);
  };

  const activateProjectContext = (id) => {
    setActiveProjectId(id);
  };

  const goToProfile = () => {
    setActiveModule('profile');
    setActiveBoardId(null);
  }

  const goToBoard = (projectId, boardId) => {
    setActiveProjectId(projectId); 
    setActiveModule('kanban'); 
    setActiveBoardId(boardId);
  };

  const exitProject = () => {
    setActiveProjectId(null);
    setActiveModule('projects');
  };

  const openBoardModal = (preSelectedProjectId = '') => {
    setSelectedProjectForBoard(preSelectedProjectId || activeProjectId || '');
    setNewBoardName('');
    setIsBoardModalOpen(true);
  };

  // --- AÇÕES DE CRUD (PROJETOS) ---

  const createProject = () => {
    if (!newProjectName.trim()) return;
    
    const companyName = companies.find(c => c.id === newProjectCompany)?.name || 'Sem Empresa';
    const groupName = groups.find(g => g.id === newProjectGroup)?.name || 'Geral';

    const newProj = {
      id: Date.now().toString(),
      name: newProjectName,
      department: groupName, 
      companyId: newProjectCompany,
      groupId: newProjectGroup,
      owner: 'Eu',
      members: ['Eu'],
      notes: [],
      boards: [],
      docs: [],
      chat: []
    };
    setProjects([...projects, newProj]);
    setNewProjectName('');
    setNewProjectCompany('');
    setNewProjectGroup('');
    setIsProjectModalOpen(false);
    if (isBoardModalOpen) setSelectedProjectForBoard(newProj.id);
  };

  const createBoard = () => {
    if (!newBoardName.trim() || !selectedProjectForBoard) return;
    
    const newBoard = {
      id: Date.now().toString(),
      name: newBoardName,
      columns: [
        { id: 'c1', title: 'A Fazer', color: 'bg-slate-100' },
        { id: 'c2', title: 'Em Andamento', color: 'bg-blue-50' },
        { id: 'c3', title: 'Concluído', color: 'bg-green-50' }
      ],
      cards: []
    };
    
    const updatedProjects = projects.map(p => {
      if (p.id === selectedProjectForBoard) {
        return { ...p, boards: [...p.boards, newBoard] };
      }
      return p;
    });

    setProjects(updatedProjects);
    setNewBoardName('');
    setIsBoardModalOpen(false);
  };

  // --- MÓDULO DE CONFIGURAÇÕES (ADMINISTRAÇÃO) ---
  const SettingsModule = () => {
    const [activeTab, setActiveTab] = useState('general'); 
    const fileInputRef = useRef(null);
    
    // Estados para Visualização e Edição
    const [viewCompany, setViewCompany] = useState(null);
    const [viewCollaborator, setViewCollaborator] = useState(null);
    const [isEditingDetail, setIsEditingDetail] = useState(false);
    const [editingData, setEditingData] = useState({}); // Objeto genérico para edição

    // Estados Colaborador (Criação)
    const [newName, setNewName] = useState('');
    const [newEmail, setNewEmail] = useState('');
    const [newEmployeeId, setNewEmployeeId] = useState('');
    const [newPis, setNewPis] = useState('');
    const [newStatus, setNewStatus] = useState('Ativo');
    const [selectedCompanyIds, setSelectedCompanyIds] = useState([]);
    const [selectedGroupIds, setSelectedGroupIds] = useState([]);

    // Estados Empresa (Criação)
    const [companyForm, setCompanyForm] = useState({
        name: '', legalName: '', cnpj: '', city: '', state: '', 
        segment: '', contactName: '', contactEmail: '', contactPhone: ''
    });
    const [isLoadingCnpj, setIsLoadingCnpj] = useState(false);

    // Estados Grupo (Criação)
    const [newGroupName, setNewGroupName] = useState('');

    // --- LÓGICA DE EMPRESA ---
    const formatCNPJ = (value) => {
        return value
            .replace(/\D/g, '')
            .replace(/^(\d{2})(\d)/, '$1.$2')
            .replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3')
            .replace(/\.(\d{3})(\d)/, '.$1/$2')
            .replace(/(\d{4})(\d)/, '$1-$2')
            .substr(0, 18);
    };

    const handleCnpjChange = (e) => {
        const masked = formatCNPJ(e.target.value);
        setCompanyForm({ ...companyForm, cnpj: masked });
    };

    const fetchCompanyData = async () => {
        const cleanCnpj = companyForm.cnpj.replace(/\D/g, '');
        if (cleanCnpj.length !== 14) return;
        setIsLoadingCnpj(true);
        try {
            // Usando BrasilAPI como fonte técnica para dados públicos
            const response = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cleanCnpj}`);
            if (!response.ok) throw new Error('Erro ao buscar CNPJ');
            const data = await response.json();
            setCompanyForm({
                ...companyForm,
                legalName: data.razao_social,
                name: data.nome_fantasia || data.razao_social,
                city: data.municipio,
                state: data.uf,
                segment: data.cnae_fiscal_descricao, // Preenche segmento com CNAE
                contactPhone: data.ddd_telefone_1,   // Tenta pegar telefone
                contactEmail: data.email             // Tenta pegar email
            });
        } catch (error) { alert('CNPJ não encontrado ou erro na busca.'); console.error(error); } 
        finally { setIsLoadingCnpj(false); }
    };

    const handleAddCompany = () => {
        if (!companyForm.name.trim()) return;
        setCompanies([...companies, { id: Date.now().toString(), ...companyForm }]);
        setCompanyForm({ name: '', legalName: '', cnpj: '', city: '', state: '', segment: '', contactName: '', contactEmail: '', contactPhone: '' });
    };

    const handleUpdateCompany = () => {
        setCompanies(companies.map(c => c.id === editingData.id ? editingData : c));
        setViewCompany(editingData); // Atualiza a view com os dados novos
        setIsEditingDetail(false);
    };

    const handleUpdateCollaborator = () => {
        setCollaborators(collaborators.map(c => c.id === editingData.id ? editingData : c));
        setViewCollaborator(editingData);
        setIsEditingDetail(false);
    };

    const handleAddGroup = () => {
        if (!newGroupName.trim()) return;
        setGroups([...groups, { id: Date.now().toString(), name: newGroupName }]);
        setNewGroupName('');
    };

    const handleAddCollaborator = () => {
        if (!newName.trim() || !newEmail.trim()) return;
        const newColab = {
            id: Date.now().toString(),
            name: newName,
            email: newEmail,
            employeeId: newEmployeeId,
            pis: newPis,
            status: newStatus,
            companyIds: selectedCompanyIds,
            groupIds: selectedGroupIds
        };
        setCollaborators([...collaborators, newColab]);
        setNewName(''); setNewEmail(''); setNewEmployeeId(''); setNewPis(''); setNewStatus('Ativo');
        setSelectedCompanyIds([]); setSelectedGroupIds([]);
    };

    const handleImportCSV = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            const content = event.target.result;
            const lines = content.split('\n');
            const newColabs = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const separator = line.includes(';') ? ';' : ',';
                const cols = line.split(separator);
                if (cols.length >= 4) {
                    newColabs.push({
                        id: Date.now() + Math.random().toString(),
                        employeeId: cols[0]?.trim() || '',
                        pis: cols[1]?.trim() || '',
                        name: cols[2]?.trim() || '',
                        email: cols[3]?.trim() || '',
                        status: cols[4]?.trim() || 'Ativo',
                        companyIds: [], groupIds: []
                    });
                }
            }
            if (newColabs.length > 0) { setCollaborators([...collaborators, ...newColabs]); alert(`${newColabs.length} colaboradores importados!`); }
            else { alert('Nenhum dado válido encontrado.'); }
        };
        reader.readAsText(file);
        if(fileInputRef.current) fileInputRef.current.value = '';
    };

    const deleteItem = (setter, list, id) => setter(list.filter(item => item.id !== id));

    const toggleSelection = (id, list, setter) => {
        if (list.includes(id)) setter(list.filter(item => item !== id));
        else setter([...list, id]);
    };

    const toggleEditSelection = (id, field) => {
        const currentList = editingData[field] || [];
        const newList = currentList.includes(id) 
            ? currentList.filter(item => item !== id) 
            : [...currentList, id];
        setEditingData({ ...editingData, [field]: newList });
    };

    return (
      <div className="flex h-full bg-white rounded-xl border border-slate-200 overflow-hidden animate-in fade-in m-6 shadow-sm">
        {/* Sidebar Configurações */}
        <div className="w-64 bg-slate-50 border-r border-slate-200 flex flex-col p-4 space-y-1">
            <h3 className="font-bold text-slate-700 mb-4 px-2">Configurações</h3>
            <button onClick={() => setActiveTab('general')} className={`text-left px-3 py-2 rounded-lg text-sm font-medium ${activeTab === 'general' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-600 hover:bg-slate-100'}`}>Geral</button>
            <button onClick={() => setActiveTab('integration')} className={`text-left px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-2 ${activeTab === 'integration' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-600 hover:bg-slate-100'}`}><RefreshCw size={16}/> Integração</button>
            
            <div className="pt-4 pb-2 px-2 text-xs font-bold text-slate-400 uppercase tracking-wider">Cadastros</div>
            <button onClick={() => setActiveTab('companies')} className={`text-left px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-2 ${activeTab === 'companies' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-600 hover:bg-slate-100'}`}><Building size={16}/> Empresas</button>
            <button onClick={() => setActiveTab('groups')} className={`text-left px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-2 ${activeTab === 'groups' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-600 hover:bg-slate-100'}`}><Layers size={16}/> Grupos</button>
            <button onClick={() => setActiveTab('collaborators')} className={`text-left px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-2 ${activeTab === 'collaborators' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-600 hover:bg-slate-100'}`}><Users size={16}/> Colaboradores</button>
            
            <div className="pt-4 pb-2 px-2 text-xs font-bold text-slate-400 uppercase tracking-wider">Dados</div>
            <button onClick={() => setActiveTab('import')} className={`text-left px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-2 ${activeTab === 'import' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-600 hover:bg-slate-100'}`}><Database size={16}/> Importação de Dados</button>
        </div>

        {/* Área de Conteúdo Configurações */}
        <div className="flex-1 p-8 overflow-y-auto custom-scrollbar">
            {activeTab === 'general' && (
                <div className="max-w-2xl">
                    <h2 className="text-2xl font-bold text-slate-800 mb-4">Configurações Gerais</h2>
                    <p className="text-slate-500 mb-6">Ajustes globais do sistema.</p>
                    <div className="bg-slate-50 p-6 rounded-xl border border-slate-200">
                        <p className="text-sm text-slate-600">Sistema: <strong>ProjectOS v2.0</strong></p>
                    </div>
                </div>
            )}

            {activeTab === 'integration' && (
                <div className="max-w-2xl">
                    <h2 className="text-2xl font-bold text-slate-800 mb-4 flex items-center gap-2"><RefreshCw className="text-indigo-600"/> Integração Senior ERP</h2>
                    <p className="text-slate-500 mb-6">Configure a conexão direta com o módulo Vetorh/Rubi.</p>
                    <div className="bg-slate-50 p-6 rounded-xl border border-slate-200 space-y-4">
                        <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">URL da API (G7)</label><input className="w-full p-2 border rounded bg-white" placeholder="https://api.senior.com.br/..." /></div>
                        <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Token de Acesso</label><input className="w-full p-2 border rounded bg-white" type="password" placeholder="••••••••••••" /></div>
                        <div className="flex items-center gap-2 pt-2"><Button variant="secondary">Testar Conexão</Button><Button>Salvar Configuração</Button></div>
                    </div>
                </div>
            )}

            {activeTab === 'companies' && (
                <div className="max-w-3xl">
                    <h2 className="text-2xl font-bold text-slate-800 mb-4 flex items-center gap-2"><Building className="text-indigo-600"/> Empresas</h2>
                    
                    <div className="bg-indigo-50 border border-indigo-100 p-6 rounded-xl mb-6">
                        <h4 className="font-bold text-indigo-900 mb-3 flex items-center gap-2">{isLoadingCnpj ? <RefreshCw className="animate-spin" size={16}/> : <Globe size={16}/>} Consulta Automática (Receita Federal)</h4>
                        
                        {/* Linha CNPJ e Nome Fantasia */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div><label className="block text-xs font-bold text-indigo-700 uppercase mb-1">CNPJ</label><div className="flex gap-2"><input className="flex-1 p-2 border border-indigo-200 rounded bg-white font-mono text-sm" placeholder="00.000.000/0000-00" value={companyForm.cnpj} onChange={handleCnpjChange} onBlur={fetchCompanyData}/><Button onClick={fetchCompanyData} className="!px-3" disabled={isLoadingCnpj}><Search size={16}/></Button></div></div>
                            <div><label className="block text-xs font-bold text-indigo-700 uppercase mb-1">Nome Fantasia</label><input className="w-full p-2 border border-indigo-200 rounded bg-white text-sm" placeholder="Preenchido automaticamente..." value={companyForm.name} onChange={e => setCompanyForm({...companyForm, name: e.target.value})}/></div>
                        </div>
                        
                        {/* Linha Razão Social e Seguimento */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div><label className="block text-xs font-bold text-indigo-700 uppercase mb-1">Razão Social</label><input className="w-full p-2 border border-indigo-200 rounded bg-slate-50 text-sm text-slate-600" readOnly value={companyForm.legalName} placeholder="..." /></div>
                            <div><label className="block text-xs font-bold text-indigo-700 uppercase mb-1">Seguimento</label><input className="w-full p-2 border border-indigo-200 rounded bg-white text-sm" value={companyForm.segment} onChange={e => setCompanyForm({...companyForm, segment: e.target.value})} placeholder="Ex: Tecnologia" /></div>
                        </div>

                        {/* Linha Localização */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div><label className="block text-xs font-bold text-indigo-700 uppercase mb-1">Cidade</label><input className="w-full p-2 border border-indigo-200 rounded bg-slate-50 text-sm text-slate-600" readOnly value={companyForm.city} placeholder="..." /></div>
                            <div><label className="block text-xs font-bold text-indigo-700 uppercase mb-1">Estado</label><input className="w-full p-2 border border-indigo-200 rounded bg-slate-50 text-sm text-slate-600" readOnly value={companyForm.state} placeholder="..." /></div>
                        </div>

                        {/* Linha de Contatos */}
                        <h5 className="font-bold text-indigo-900 text-xs uppercase mb-3 border-b border-indigo-200 pb-1 mt-4 flex items-center gap-2"><UserCircle size={14}/> Contato Principal</h5>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <input className="w-full p-2 border border-indigo-200 rounded bg-white text-sm" placeholder="Nome do Contato" value={companyForm.contactName} onChange={e => setCompanyForm({...companyForm, contactName: e.target.value})}/>
                            <input className="w-full p-2 border border-indigo-200 rounded bg-white text-sm" placeholder="Email" value={companyForm.contactEmail} onChange={e => setCompanyForm({...companyForm, contactEmail: e.target.value})}/>
                            <input className="w-full p-2 border border-indigo-200 rounded bg-white text-sm" placeholder="Telefone" value={companyForm.contactPhone} onChange={e => setCompanyForm({...companyForm, contactPhone: e.target.value})}/>
                        </div>

                        <Button onClick={handleAddCompany} icon={Plus} className="w-full">Adicionar Empresa</Button>
                    </div>

                    <div className="space-y-3">
                        {companies.map(c => (
                            <div key={c.id} onClick={() => { setViewCompany(c); setIsEditingDetail(false); setEditingData({...c}); }} className="p-4 bg-white rounded-lg border border-slate-200 flex justify-between items-center shadow-sm cursor-pointer hover:border-indigo-400 transition-colors group">
                                <div><div className="flex items-center gap-2"><span className="font-bold text-slate-700 group-hover:text-indigo-700">{c.name}</span>{c.state && <Badge color="bg-slate-100 text-slate-500">{c.city}/{c.state}</Badge>}</div><div className="text-xs text-slate-400 mt-1 flex gap-3">{c.cnpj && <span>CNPJ: {c.cnpj}</span>}{c.segment && <span>Seguimento: {c.segment}</span>}</div></div>
                                <button onClick={(e) => { e.stopPropagation(); deleteItem(setCompanies, companies, c.id); }} className="text-slate-400 hover:text-red-500 p-2"><Trash2 size={16}/></button>
                            </div>
                        ))}
                    </div>

                    {/* MODAL DETALHES DA EMPRESA (COM EDIÇÃO ATUALIZADA) */}
                    <Modal isOpen={!!viewCompany} onClose={() => setViewCompany(null)} title={isEditingDetail ? "Editar Empresa" : "Detalhes da Empresa"}>
                        {viewCompany && (
                            <div className="space-y-6">
                                {!isEditingDetail ? (
                                    <>
                                        <div className="text-center pb-4 border-b border-slate-100">
                                            <div className="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-3 text-indigo-600"><Building size={32} /></div>
                                            <h3 className="text-xl font-bold text-slate-800">{viewCompany.name}</h3>
                                            <p className="text-sm text-slate-500 font-mono">{viewCompany.cnpj}</p>
                                            {viewCompany.segment && <p className="text-xs text-indigo-600 font-bold mt-1 uppercase tracking-wider">{viewCompany.segment}</p>}
                                        </div>
                                        <div className="space-y-4">
                                            <div><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Razão Social</label><p className="text-sm font-medium text-slate-800 bg-slate-50 p-2 rounded">{viewCompany.legalName || '-'}</p></div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Cidade</label><p className="text-sm font-medium text-slate-800 bg-slate-50 p-2 rounded">{viewCompany.city || '-'}</p></div>
                                                <div><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Estado</label><p className="text-sm font-medium text-slate-800 bg-slate-50 p-2 rounded">{viewCompany.state || '-'}</p></div>
                                            </div>
                                            {(viewCompany.contactName || viewCompany.contactEmail || viewCompany.contactPhone) && (
                                                <div className="bg-indigo-50 p-3 rounded-lg border border-indigo-100 mt-2">
                                                    <h5 className="font-bold text-indigo-800 text-xs uppercase mb-2">Contato Principal</h5>
                                                    <div className="space-y-1 text-sm text-indigo-900">
                                                        {viewCompany.contactName && <div className="flex items-center gap-2"><User size={14}/> {viewCompany.contactName}</div>}
                                                        {viewCompany.contactEmail && <div className="flex items-center gap-2"><Mail size={14}/> {viewCompany.contactEmail}</div>}
                                                        {viewCompany.contactPhone && <div className="flex items-center gap-2"><Phone size={14}/> {viewCompany.contactPhone}</div>}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                        <div className="flex justify-between pt-4 border-t border-slate-100">
                                            <Button variant="secondary" onClick={() => setViewCompany(null)}>Fechar</Button>
                                            <Button onClick={() => setIsEditingDetail(true)} icon={Edit2}>Editar</Button>
                                        </div>
                                    </>
                                ) : (
                                    <>
                                        <div className="space-y-4">
                                            <div className="grid grid-cols-2 gap-4">
                                                <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">CNPJ</label><input className="w-full p-2 border rounded" value={editingData.cnpj} onChange={e => setEditingData({...editingData, cnpj: e.target.value})} /></div>
                                                <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Nome Fantasia</label><input className="w-full p-2 border rounded" value={editingData.name} onChange={e => setEditingData({...editingData, name: e.target.value})} /></div>
                                            </div>
                                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Razão Social</label><input className="w-full p-2 border rounded" value={editingData.legalName} onChange={e => setEditingData({...editingData, legalName: e.target.value})} /></div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Seguimento</label><input className="w-full p-2 border rounded" value={editingData.segment} onChange={e => setEditingData({...editingData, segment: e.target.value})} /></div>
                                                <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Estado</label><input className="w-full p-2 border rounded" value={editingData.state} onChange={e => setEditingData({...editingData, state: e.target.value})} /></div>
                                            </div>
                                            
                                            <div className="border-t border-slate-100 pt-3">
                                                <label className="block text-xs font-bold text-indigo-500 uppercase mb-2">Contato</label>
                                                <div className="space-y-2">
                                                    <input className="w-full p-2 border rounded text-sm" placeholder="Nome" value={editingData.contactName} onChange={e => setEditingData({...editingData, contactName: e.target.value})} />
                                                    <input className="w-full p-2 border rounded text-sm" placeholder="Email" value={editingData.contactEmail} onChange={e => setEditingData({...editingData, contactEmail: e.target.value})} />
                                                    <input className="w-full p-2 border rounded text-sm" placeholder="Telefone" value={editingData.contactPhone} onChange={e => setEditingData({...editingData, contactPhone: e.target.value})} />
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex justify-end gap-2 pt-4 border-t border-slate-100">
                                            <Button variant="secondary" onClick={() => setIsEditingDetail(false)}>Cancelar</Button>
                                            <Button onClick={handleUpdateCompany} icon={Save}>Salvar Alterações</Button>
                                        </div>
                                    </>
                                )}
                            </div>
                        )}
                    </Modal>
                </div>
            )}

            {activeTab === 'groups' && (
                <div className="max-w-3xl">
                    <h2 className="text-2xl font-bold text-slate-800 mb-4 flex items-center gap-2"><Layers className="text-indigo-600"/> Grupos de Atividades</h2>
                    <div className="flex gap-2 mb-6"><input className="flex-1 p-2 border rounded-lg" placeholder="Nome do Grupo (ex: Marketing)" value={newGroupName} onChange={e => setNewGroupName(e.target.value)} /><Button onClick={handleAddGroup} icon={Plus}>Adicionar</Button></div>
                    <div className="grid grid-cols-2 gap-3">{groups.map(g => (<div key={g.id} className="flex justify-between items-center p-3 bg-white border border-slate-200 rounded-lg shadow-sm"><div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-indigo-400"></div><span className="font-medium text-slate-700">{g.name}</span></div><button onClick={() => deleteItem(setGroups, groups, g.id)} className="text-slate-300 hover:text-red-500"><X size={16}/></button></div>))}</div>
                </div>
            )}

            {activeTab === 'collaborators' && (
                <div className="max-w-5xl">
                    <h2 className="text-2xl font-bold text-slate-800 mb-4 flex items-center gap-2"><Users className="text-indigo-600"/> Cadastro de Colaboradores</h2>
                    <div className="bg-slate-50 p-6 rounded-xl border border-slate-200 mb-8">
                        <h4 className="font-bold text-sm text-slate-700 mb-3 border-b border-slate-200 pb-2">Novo Colaborador (Manual)</h4>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <input className="w-full p-2 border rounded bg-white text-sm" placeholder="Nome Completo" value={newName} onChange={e => setNewName(e.target.value)} />
                            <input className="w-full p-2 border rounded bg-white text-sm" placeholder="Email Corporativo (mail)" value={newEmail} onChange={e => setNewEmail(e.target.value)} />
                            <select className="w-full p-2 border rounded bg-white text-sm" value={newStatus} onChange={e => setNewStatus(e.target.value)}><option value="Ativo">Ativo</option><option value="Férias">Férias</option><option value="Inativo">Inativo</option></select>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input className="w-full p-2 border rounded bg-white text-sm" placeholder="Matrícula (employeeId)" value={newEmployeeId} onChange={e => setNewEmployeeId(e.target.value)} />
                            <input className="w-full p-2 border rounded bg-white text-sm" placeholder="PIS" value={newPis} onChange={e => setNewPis(e.target.value)} />
                        </div>
                        <div className="grid grid-cols-2 gap-6 mb-4">
                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-2">Vincular Empresas</label><div className="space-y-1 max-h-32 overflow-y-auto custom-scrollbar bg-white p-2 border rounded">{companies.map(c => (<label key={c.id} className="flex items-center gap-2 text-sm text-slate-700 cursor-pointer hover:bg-slate-50 p-1 rounded"><input type="checkbox" checked={selectedCompanyIds.includes(c.id)} onChange={() => toggleSelection(c.id, selectedCompanyIds, setSelectedCompanyIds)} />{c.name}</label>))}</div></div>
                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-2">Vincular Grupos</label><div className="space-y-1 max-h-32 overflow-y-auto custom-scrollbar bg-white p-2 border rounded">{groups.map(g => (<label key={g.id} className="flex items-center gap-2 text-sm text-slate-700 cursor-pointer hover:bg-slate-50 p-1 rounded"><input type="checkbox" checked={selectedGroupIds.includes(g.id)} onChange={() => toggleSelection(g.id, selectedGroupIds, setSelectedGroupIds)} />{g.name}</label>))}</div></div>
                        </div>
                        <Button onClick={handleAddCollaborator} icon={Plus} className="w-full">Salvar Colaborador</Button>
                    </div>

                    <div className="space-y-3">
                        <div className="flex justify-between text-xs font-bold text-slate-400 px-4 uppercase"><span className="w-1/4">Nome / Email</span><span className="w-1/6">Matrícula / PIS</span><span className="w-1/6">Status</span><span className="w-1/3">Vínculos</span><span className="w-10"></span></div>
                        {collaborators.map(col => {
                            const colCompanies = companies.filter(c => col.companyIds.includes(c.id)).map(c => c.name);
                            const colGroups = groups.filter(g => col.groupIds.includes(g.id)).map(g => g.name);
                            return (
                                <div key={col.id} onClick={() => { setViewCollaborator(col); setIsEditingDetail(false); setEditingData({...col}); }} className="p-4 bg-white border border-slate-200 rounded-lg shadow-sm hover:border-indigo-300 transition-colors flex items-center justify-between cursor-pointer group">
                                    <div className="w-1/4"><h4 className="font-bold text-slate-800 text-sm group-hover:text-indigo-700">{col.name}</h4><p className="text-xs text-slate-500">{col.email}</p></div>
                                    <div className="w-1/6"><p className="text-xs font-mono text-slate-600">{col.employeeId || '-'}</p><p className="text-[10px] text-slate-400">{col.pis || '-'}</p></div>
                                    <div className="w-1/6"><Badge color={col.status === 'Ativo' ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-500'}>{col.status}</Badge></div>
                                    <div className="w-1/3 flex flex-wrap gap-1">{colCompanies.map((c, i) => <span key={i} className="text-[10px] bg-blue-50 text-blue-700 px-1.5 py-0.5 rounded">{c}</span>)}{colGroups.map((g, i) => <span key={i} className="text-[10px] bg-indigo-50 text-indigo-700 px-1.5 py-0.5 rounded">{g}</span>)}</div>
                                    <div className="w-10 text-right"><button onClick={(e) => { e.stopPropagation(); deleteItem(setCollaborators, collaborators, col.id); }} className="text-slate-300 hover:text-red-500 p-2"><Trash2 size={16}/></button></div>
                                </div>
                            );
                        })}
                    </div>

                    {/* MODAL DETALHES DO COLABORADOR (COM EDIÇÃO) */}
                    <Modal isOpen={!!viewCollaborator} onClose={() => setViewCollaborator(null)} title={isEditingDetail ? "Editar Colaborador" : "Detalhes do Colaborador"}>
                        {viewCollaborator && (
                            <div className="space-y-6">
                                {!isEditingDetail ? (
                                    <>
                                        <div className="flex items-center gap-4 pb-4 border-b border-slate-100">
                                            <div className="w-16 h-16 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-3xl font-bold">{viewCollaborator.name.charAt(0)}</div>
                                            <div><h3 className="text-xl font-bold text-slate-800">{viewCollaborator.name}</h3><p className="text-sm text-slate-500">{viewCollaborator.email}</p><div className="mt-1"><Badge color={viewCollaborator.status === 'Ativo' ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-500'}>{viewCollaborator.status}</Badge></div></div>
                                        </div>
                                        <div className="space-y-4">
                                            <div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Matrícula</label><p className="text-sm font-medium text-slate-800 bg-slate-50 p-2 rounded font-mono">{viewCollaborator.employeeId || '-'}</p></div><div><label className="block text-xs font-bold text-slate-400 uppercase mb-1">PIS</label><p className="text-sm font-medium text-slate-800 bg-slate-50 p-2 rounded font-mono">{viewCollaborator.pis || '-'}</p></div></div>
                                            <div><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Empresas Vinculadas</label><div className="flex flex-wrap gap-2 mt-1">{companies.filter(c => viewCollaborator.companyIds.includes(c.id)).length > 0 ? (companies.filter(c => viewCollaborator.companyIds.includes(c.id)).map(c => (<span key={c.id} className="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded-full border border-blue-100 flex items-center gap-1"><Building size={12}/> {c.name}</span>))) : <span className="text-sm text-slate-400 italic">Nenhuma vinculada.</span>}</div></div>
                                            <div><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Grupos de Atividades</label><div className="flex flex-wrap gap-2 mt-1">{groups.filter(g => viewCollaborator.groupIds.includes(g.id)).length > 0 ? (groups.filter(g => viewCollaborator.groupIds.includes(g.id)).map(g => (<span key={g.id} className="text-xs bg-indigo-50 text-indigo-700 px-2 py-1 rounded-full border border-indigo-100 flex items-center gap-1"><Layers size={12}/> {g.name}</span>))) : <span className="text-sm text-slate-400 italic">Nenhum vinculado.</span>}</div></div>
                                        </div>
                                        <div className="flex justify-between pt-4 border-t border-slate-100">
                                            <Button variant="secondary" onClick={() => setViewCollaborator(null)}>Fechar</Button>
                                            <Button onClick={() => setIsEditingDetail(true)} icon={Edit2}>Editar</Button>
                                        </div>
                                    </>
                                ) : (
                                    <>
                                        <div className="space-y-4">
                                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Nome Completo</label><input className="w-full p-2 border rounded" value={editingData.name} onChange={e => setEditingData({...editingData, name: e.target.value})} /></div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Email</label><input className="w-full p-2 border rounded" value={editingData.email} onChange={e => setEditingData({...editingData, email: e.target.value})} /></div>
                                                <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Status</label><select className="w-full p-2 border rounded" value={editingData.status} onChange={e => setEditingData({...editingData, status: e.target.value})}><option value="Ativo">Ativo</option><option value="Férias">Férias</option><option value="Inativo">Inativo</option></select></div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Matrícula</label><input className="w-full p-2 border rounded" value={editingData.employeeId} onChange={e => setEditingData({...editingData, employeeId: e.target.value})} /></div>
                                                <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">PIS</label><input className="w-full p-2 border rounded" value={editingData.pis} onChange={e => setEditingData({...editingData, pis: e.target.value})} /></div>
                                            </div>
                                            
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Empresas</label>
                                                    <div className="space-y-1 max-h-32 overflow-y-auto custom-scrollbar bg-slate-50 p-2 border rounded">
                                                        {companies.map(c => (
                                                            <label key={c.id} className="flex items-center gap-2 text-xs text-slate-700 cursor-pointer">
                                                                <input type="checkbox" checked={editingData.companyIds?.includes(c.id)} onChange={() => toggleEditSelection(c.id, 'companyIds')} />
                                                                {c.name}
                                                            </label>
                                                        ))}
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Grupos</label>
                                                    <div className="space-y-1 max-h-32 overflow-y-auto custom-scrollbar bg-slate-50 p-2 border rounded">
                                                        {groups.map(g => (
                                                            <label key={g.id} className="flex items-center gap-2 text-xs text-slate-700 cursor-pointer">
                                                                <input type="checkbox" checked={editingData.groupIds?.includes(g.id)} onChange={() => toggleEditSelection(g.id, 'groupIds')} />
                                                                {g.name}
                                                            </label>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex justify-end gap-2 pt-4 border-t border-slate-100">
                                            <Button variant="secondary" onClick={() => setIsEditingDetail(false)}>Cancelar</Button>
                                            <Button onClick={handleUpdateCollaborator} icon={Save}>Salvar Alterações</Button>
                                        </div>
                                    </>
                                )}
                            </div>
                        )}
                    </Modal>
                </div>
            )}

            {activeTab === 'import' && (
                <div className="max-w-2xl">
                    <h2 className="text-2xl font-bold text-slate-800 mb-4 flex items-center gap-2"><Database className="text-indigo-600"/> Importação de Dados</h2>
                    <p className="text-slate-500 mb-6">Importe colaboradores em massa usando o layout de exportação da Senior.</p>
                    
                    <div className="bg-slate-50 border-2 border-dashed border-slate-300 rounded-xl p-10 flex flex-col items-center justify-center text-center">
                        <FileSpreadsheet size={48} className="text-slate-400 mb-4" />
                        <h3 className="font-bold text-slate-700 mb-2">Upload de Arquivo CSV</h3>
                        <p className="text-sm text-slate-500 max-w-md mb-6">
                            O arquivo deve conter as colunas na ordem:<br/>
                            <code className="bg-slate-200 px-1 rounded text-slate-700">employeeId,PIS,name,mail,status</code>
                        </p>
                        
                        <input 
                            type="file" 
                            ref={fileInputRef} 
                            className="hidden" 
                            accept=".csv,.txt" 
                            onChange={handleImportCSV} 
                        />
                        <Button onClick={() => fileInputRef.current?.click()} icon={Upload}>
                            Selecionar Arquivo
                        </Button>
                    </div>

                    <div className="mt-8">
                        <h4 className="font-bold text-sm text-slate-700 mb-2">Histórico de Importações</h4>
                        <div className="text-xs text-slate-400 italic">Nenhuma importação recente.</div>
                    </div>
                </div>
            )}
        </div>
      </div>
    );
  };

  // --- COMPONENTES AUXILIARES ---

  // Seletor de Projetos Integrado
  const ProjectContextSelector = ({ onSelect }) => (
    <div className="flex flex-col items-center justify-center h-full p-8 animate-in fade-in">
      <div className="max-w-2xl w-full">
        <div className="text-center mb-8">
          <h2 className="text-2xl font-bold text-slate-800">Selecione um Projeto</h2>
          <p className="text-slate-500">Escolha o contexto de trabalho.</p>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          {projects.map(p => (
            <button key={p.id} onClick={() => onSelect(p.id)} className="flex items-center gap-4 p-4 bg-white border border-slate-200 rounded-xl hover:border-indigo-500 hover:shadow-md transition-all text-left group">
              <div className="p-3 bg-indigo-50 text-indigo-600 rounded-lg group-hover:bg-indigo-600 group-hover:text-white transition-colors"><Folder size={24} /></div>
              <div><h3 className="font-bold text-slate-800">{p.name}</h3><span className="text-xs text-slate-500">{p.department}</span></div>
              <ChevronRight className="ml-auto text-slate-300 group-hover:text-indigo-500" size={20} />
            </button>
          ))}
          <button onClick={() => setIsProjectModalOpen(true)} className="flex items-center gap-4 p-4 border-2 border-dashed border-slate-300 rounded-xl hover:border-indigo-400 hover:bg-indigo-50/50 transition-all text-left text-slate-500 hover:text-indigo-600">
            <div className="p-3 bg-slate-100 rounded-lg"><Plus size={24} /></div><span className="font-medium">Criar Novo Projeto</span>
          </button>
        </div>
      </div>
    </div>
  );

  const PlaceholderView = ({ title, icon: Icon, description }) => (
    <div className="flex flex-col items-center justify-center h-full text-center p-8 animate-in fade-in duration-300">
      <div className="p-4 bg-slate-100 rounded-full mb-4"><Icon size={48} className="text-slate-400" /></div>
      <h2 className="text-2xl font-bold text-slate-800 mb-2">{title}</h2>
      <p className="text-slate-500 max-w-md">{description || "Este módulo está em desenvolvimento."}</p>
    </div>
  );

  const PlaceholderSelectProject = ({ moduleName }) => (
    <div className="flex flex-col items-center justify-center h-full text-center p-8 animate-in fade-in duration-300">
      <div className="p-4 bg-indigo-50 rounded-full mb-4"><Folder size={48} className="text-indigo-400" /></div>
      <h2 className="text-2xl font-bold text-slate-800 mb-2">Selecione um Projeto</h2>
      <p className="text-slate-500 max-w-md mb-6">Para acessar o módulo de <strong>{moduleName}</strong>, você precisa selecionar um projeto ativo.</p>
      <Button onClick={() => navigateTo('projects')}>Ir para Lista de Projetos</Button>
    </div>
  );

  // 2. PERFIL
  const UserProfileView = () => {
    const [editMode, setEditMode] = useState(false);
    const [formData, setFormData] = useState(user);
    const handleSaveProfile = () => { setUser(formData); setEditMode(false); };
    return (
      <div className="max-w-4xl mx-auto p-8 animate-in fade-in duration-300">
        <div className="flex items-center gap-2 mb-6"><h1 className="text-2xl font-bold text-slate-800">Meu Perfil</h1></div>
        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-8">
           <div className="flex items-center gap-6 mb-8">
             <div className="w-24 h-24 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-3xl font-bold">{user.name.charAt(0)}</div>
             <div><h2 className="text-2xl font-bold text-slate-800">{user.name}</h2><p className="text-slate-500">{user.role}</p></div>
           </div>
           <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Nome</label><input disabled={!editMode} value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full p-2 border rounded bg-slate-50" /></div>
              <div><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Email</label><input disabled={!editMode} value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} className="w-full p-2 border rounded bg-slate-50" /></div>
           </div>
           <div className="mt-6 flex gap-2"><Button variant={editMode ? "primary" : "secondary"} onClick={() => editMode ? handleSaveProfile() : setEditMode(true)}>{editMode ? "Salvar" : "Editar"}</Button></div>
        </div>
      </div>
    );
  };

  // 3. LISTA DE PROJETOS
  const ProjectsListView = () => (
    <div className="p-8 max-w-7xl mx-auto animate-in fade-in duration-300">
      <div className="flex justify-between items-center mb-8">
        <div><h1 className="text-3xl font-bold text-slate-800">Meus Projetos</h1><p className="text-slate-500 mt-1">Selecione um projeto para gerenciar</p></div>
        <Button onClick={() => setIsProjectModalOpen(true)} icon={Plus}>Novo Projeto</Button>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {projects.map(proj => {
            const compName = companies.find(c => c.id === proj.companyId)?.name;
            return (
                <div key={proj.id} onClick={() => selectProject(proj.id)} className="group bg-white p-6 rounded-xl border border-slate-200 hover:border-indigo-300 hover:shadow-md transition-all cursor-pointer flex flex-col h-48 relative overflow-hidden">
                    {activeProjectId === proj.id && <div className="absolute top-0 left-0 w-1 h-full bg-indigo-600"></div>}
                    <div className="flex justify-between items-start mb-4">
                        <div className="p-3 bg-indigo-50 text-indigo-600 rounded-lg group-hover:bg-indigo-600 group-hover:text-white transition-colors"><Folder size={24} /></div>
                        <div className="flex flex-col items-end">
                            <Badge>{proj.department}</Badge>
                            {compName && <span className="text-[10px] text-slate-400 mt-1">{compName}</span>}
                        </div>
                    </div>
                    <h3 className="text-xl font-bold text-slate-800 mb-2">{proj.name}</h3>
                    <p className="text-sm text-slate-500 line-clamp-2 mb-4 flex-1">{proj.description || 'Sem descrição.'}</p>
                    <div className="flex items-center justify-between pt-4 border-t border-slate-50"><span className="text-xs font-medium text-slate-400">{proj.boards.length} boards</span></div>
                </div>
            );
        })}
        <button onClick={() => setIsProjectModalOpen(true)} className="h-48 rounded-xl border-2 border-dashed border-slate-300 flex flex-col items-center justify-center text-slate-400 hover:text-indigo-600 hover:border-indigo-400 hover:bg-indigo-50/30 transition-all gap-2">
          <Plus size={32} /><span className="font-medium">Criar Novo Projeto</span>
        </button>
      </div>
    </div>
  );

  // 4. DASHBOARD
  const ProjectDashboard = () => {
    if (!activeProject) return <ProjectsListView />;
    const totalBoards = activeProject.boards.length;
    const totalCards = activeProject.boards.reduce((acc, b) => acc + b.cards.length, 0);
    return (
      <div className="space-y-8 animate-in fade-in duration-300 p-8">
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm"><h3 className="text-slate-500 text-sm font-medium mb-1">Total de Boards</h3><p className="text-3xl font-bold text-slate-800">{totalBoards}</p></div>
          <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm"><h3 className="text-slate-500 text-sm font-medium mb-1">Atividades Totais</h3><p className="text-3xl font-bold text-slate-800">{totalCards}</p></div>
          <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm"><h3 className="text-slate-500 text-sm font-medium mb-1">Participantes</h3><p className="text-3xl font-bold text-slate-800">{activeProject.members.length}</p></div>
        </div>
        <div>
           <div className="flex justify-between items-center mb-4"><h3 className="text-xl font-bold text-slate-800">Fluxos de Trabalho (Boards)</h3><Button onClick={() => openBoardModal(activeProject.id)} variant="ghost" icon={Plus}>Novo Quadro</Button></div>
           <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {activeProject.boards.map(board => (
                <div key={board.id} onClick={() => goToBoard(activeProject.id, board.id)} className="group bg-white p-5 rounded-xl border border-slate-200 hover:border-indigo-300 hover:shadow-md transition-all cursor-pointer flex flex-col h-40">
                  <div className="flex justify-between items-center mb-3"><div className="p-2 bg-indigo-50 text-indigo-600 rounded-lg group-hover:bg-indigo-600 group-hover:text-white transition-colors"><Layout size={20} /></div><div className="bg-slate-100 text-slate-500 text-xs px-2 py-1 rounded-full">{board.cards.length} cards</div></div>
                  <h4 className="font-bold text-lg text-slate-800 mb-1">{board.name}</h4>
                  <p className="text-sm text-slate-500 flex-1">{board.columns.length} colunas configuradas</p>
                  <div className="mt-auto pt-3 border-t border-slate-50 flex items-center justify-between text-xs font-medium text-slate-400 group-hover:text-indigo-600 transition-colors"><span>Acessar quadro</span><ChevronRight size={14} /></div>
                </div>
              ))}
              <button onClick={() => openBoardModal(activeProject.id)} className="h-40 rounded-xl border-2 border-dashed border-slate-300 flex flex-col items-center justify-center text-slate-400 hover:text-indigo-600 hover:border-indigo-400 hover:bg-indigo-50/30 transition-all gap-2"><Plus size={24} /><span className="font-medium">Criar Novo Quadro</span></button>
           </div>
        </div>
      </div>
    );
  };

  // 5. KANBAN HUB
  const KanbanHub = () => {
    return (
      <div className="space-y-8 animate-in fade-in duration-300 p-8">
        <div className="flex justify-between items-center border-b border-slate-100 pb-6"><div><h2 className="text-2xl font-bold text-slate-800">Todos os Quadros</h2><p className="text-slate-500">Visualização de Kanban segmentada por projetos.</p></div><Button onClick={() => openBoardModal()} icon={Plus}>Novo Board</Button></div>
        {projects.map(proj => (
           <div key={proj.id} className="space-y-4">
              <div className="flex items-center gap-2"><Folder size={18} className="text-slate-400" /><h3 className="text-lg font-bold text-slate-700">{proj.name}</h3><span className="text-xs bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full">{proj.boards.length}</span></div>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                 {proj.boards.map(board => (
                   <div key={board.id} onClick={() => goToBoard(proj.id, board.id)} className="group bg-white rounded-lg border border-slate-200 overflow-hidden hover:shadow-md hover:border-indigo-300 transition-all cursor-pointer">
                     <div className="h-1 bg-indigo-500 w-full"></div>
                     <div className="p-4"><h4 className="font-bold text-slate-800 mb-1 flex items-center justify-between">{board.name}<ArrowRightLeft size={14} className="opacity-0 group-hover:opacity-100 text-indigo-500 transition-opacity" /></h4><p className="text-xs text-slate-500">{board.cards.length} atividades • {board.columns.length} colunas</p></div>
                   </div>
                 ))}
                 <button onClick={() => openBoardModal(proj.id)} className="rounded-lg border border-dashed border-slate-300 flex items-center justify-center gap-2 text-sm text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 hover:border-indigo-200 transition-all h-[86px]"><Plus size={16} /> Novo em {proj.name.split(' ')[0]}...</button>
              </div>
           </div>
        ))}
        {projects.length === 0 && <div className="text-center py-12"><p className="text-slate-500 mb-4">Você ainda não tem projetos.</p><Button onClick={() => setIsProjectModalOpen(true)}>Criar Primeiro Projeto</Button></div>}
      </div>
    );
  };

  // 6. STICKY NOTES MODULE
  const NotesModule = () => {
    if (!activeProjectId) return <ProjectContextSelector onSelect={activateProjectContext} />;
    const [localNotes, setLocalNotes] = useState(activeProject.notes || []);
    const [draggingNoteId, setDraggingNoteId] = useState(null);
    const dragOffset = useRef({ x: 0, y: 0 });
    const colors = [{ id: 'yellow', class: 'bg-yellow-200' }, { id: 'blue', class: 'bg-blue-200' }, { id: 'green', class: 'bg-green-200' }, { id: 'pink', class: 'bg-pink-200' }, { id: 'purple', class: 'bg-purple-200' }];
    const saveNotesToProject = (updatedNotes) => { const updatedProjects = projects.map(p => { if (p.id === activeProjectId) { return { ...p, notes: updatedNotes }; } return p; }); setProjects(updatedProjects); };
    const addNote = () => { const newNote = { id: Date.now().toString(), text: '', color: 'bg-yellow-200', x: Math.random() * 200 + 50, y: Math.random() * 100 + 50 }; const newNotesList = [...localNotes, newNote]; setLocalNotes(newNotesList); saveNotesToProject(newNotesList); };
    const deleteNote = (noteId) => { const newNotesList = localNotes.filter(n => n.id !== noteId); setLocalNotes(newNotesList); saveNotesToProject(newNotesList); };
    const updateNoteText = (noteId, text) => { const newNotesList = localNotes.map(n => n.id === noteId ? { ...n, text } : n); setLocalNotes(newNotesList); };
    const updateNoteColor = (noteId, colorClass) => { const newNotesList = localNotes.map(n => n.id === noteId ? { ...n, color: colorClass } : n); setLocalNotes(newNotesList); saveNotesToProject(newNotesList); };
    const handleMouseDown = (e, note) => { e.stopPropagation(); setDraggingNoteId(note.id); dragOffset.current = { x: e.clientX - note.x, y: e.clientY - note.y }; };
    const handleMouseMove = (e) => { if (draggingNoteId) { const newX = e.clientX - dragOffset.current.x; const newY = e.clientY - dragOffset.current.y; setLocalNotes(prev => prev.map(n => n.id === draggingNoteId ? { ...n, x: newX, y: newY } : n)); } };
    const handleMouseUp = () => { if (draggingNoteId) { saveNotesToProject(localNotes); setDraggingNoteId(null); } };
    useEffect(() => { if (draggingNoteId) { window.addEventListener('mousemove', handleMouseMove); window.addEventListener('mouseup', handleMouseUp); } return () => { window.removeEventListener('mousemove', handleMouseMove); window.removeEventListener('mouseup', handleMouseUp); }; }, [draggingNoteId]);

    return (
      <div className="h-full flex flex-col p-6 animate-in fade-in">
        <div className="flex justify-between items-center mb-4"><div><h2 className="text-2xl font-bold text-slate-800">Quadro de Anotações: {activeProject.name}</h2><p className="text-slate-500 text-sm">Arraste para organizar. Use cores para categorizar.</p></div>
          <div className="flex items-center gap-2"><button onClick={() => setActiveProjectId(null)} className="text-xs text-indigo-600 hover:underline flex items-center gap-1"><ArrowRightLeft size={12}/> Trocar Projeto</button><Button onClick={addNote} icon={Plus}>Nova Nota</Button></div>
        </div>
        <div className="flex-1 bg-slate-100 rounded-xl border border-slate-300 relative overflow-hidden shadow-inner" style={{ backgroundImage: 'radial-gradient(#cbd5e1 1px, transparent 1px)', backgroundSize: '20px 20px' }}>
          {localNotes.map(note => (
            <div key={note.id} className={`absolute w-64 h-64 rounded-lg shadow-lg flex flex-col transition-shadow ${note.color} ${draggingNoteId === note.id ? 'shadow-2xl z-50 cursor-grabbing' : 'shadow-md cursor-default hover:shadow-xl'}`} style={{ left: note.x, top: note.y }}>
              <div className="h-8 w-full bg-black/5 cursor-grab active:cursor-grabbing flex justify-between items-center px-2 rounded-t-lg" onMouseDown={(e) => handleMouseDown(e, note)}>
                <GripHorizontal size={14} className="text-black/30" /><div className="flex gap-1"><div className="flex gap-1 mr-2">{colors.map(c => (<button key={c.id} onClick={(e) => { e.stopPropagation(); updateNoteColor(note.id, c.class); }} className={`w-3 h-3 rounded-full border border-black/10 ${c.class} hover:scale-125 transition-transform`} title={c.id} />))}</div><button onClick={(e) => { e.stopPropagation(); deleteNote(note.id); }} className="text-black/30 hover:text-red-600 transition-colors"><X size={14} /></button></div>
              </div>
              <textarea className="flex-1 bg-transparent p-4 resize-none outline-none text-slate-800 font-medium leading-relaxed custom-scrollbar placeholder-black/30" placeholder="Escreva algo..." value={note.text} onChange={(e) => updateNoteText(note.id, e.target.value)} onBlur={() => saveNotesToProject(localNotes)} />
            </div>
          ))}
          {localNotes.length === 0 && <div className="absolute inset-0 flex flex-col items-center justify-center text-slate-400 pointer-events-none"><StickyNote size={64} className="mb-4 opacity-20" /><p>O quadro está vazio. Adicione uma nota para começar.</p></div>}
        </div>
      </div>
    );
  };

  // 7. DOCUMENTATION (WIKI) MODULE
  const ProjectDocs = () => {
    if (!activeProjectId) return <ProjectContextSelector onSelect={activateProjectContext} />;
    const [activeDocId, setActiveDocId] = useState(activeProject.docs?.[0]?.id || null);
    const [isEditing, setIsEditing] = useState(false);
    const [editTitle, setEditTitle] = useState('');
    const [editContent, setEditContent] = useState('');
    const activeDoc = activeProject.docs?.find(d => d.id === activeDocId);
    useEffect(() => { if (activeDoc) { setEditTitle(activeDoc.title); setEditContent(activeDoc.content); } }, [activeDocId, activeDoc]);
    const createDoc = () => { const newDoc = { id: Date.now().toString(), title: 'Novo Documento', content: '' }; const updatedProjects = projects.map(p => { if (p.id === activeProjectId) { return { ...p, docs: [...(p.docs || []), newDoc] }; } return p; }); setProjects(updatedProjects); setActiveDocId(newDoc.id); setIsEditing(true); };
    const saveDoc = () => { if (!activeDocId) return; const updatedProjects = projects.map(p => { if (p.id === activeProjectId) { const newDocs = p.docs.map(d => d.id === activeDocId ? { ...d, title: editTitle, content: editContent } : d); return { ...p, docs: newDocs }; } return p; }); setProjects(updatedProjects); setIsEditing(false); };
    const deleteDoc = (docId) => { if (!window.confirm('Excluir este documento?')) return; const updatedProjects = projects.map(p => { if (p.id === activeProjectId) { return { ...p, docs: p.docs.filter(d => d.id !== docId) }; } return p; }); setProjects(updatedProjects); if (activeDocId === docId) setActiveDocId(null); };

    return (
      <div className="h-full flex bg-white rounded-xl border border-slate-200 overflow-hidden animate-in fade-in m-6 shadow-sm">
        <div className="w-64 bg-slate-50 border-r border-slate-200 flex flex-col">
          <div className="p-4 border-b border-slate-200 flex justify-between items-center bg-white"><span className="font-bold text-slate-700 text-sm flex items-center gap-2"><FileText size={16} /> Documentos</span><button onClick={createDoc} className="p-1 hover:bg-slate-100 rounded text-indigo-600 transition-colors"><Plus size={18} /></button></div>
          <div className="flex-1 overflow-y-auto p-2 space-y-1">{activeProject.docs?.length === 0 && <div className="text-center p-4 text-xs text-slate-400">Nenhum documento.</div>}{activeProject.docs?.map(doc => (<button key={doc.id} onClick={() => { setActiveDocId(doc.id); setIsEditing(false); }} className={`w-full text-left px-3 py-2 rounded-lg text-sm truncate transition-colors flex justify-between group ${activeDocId === doc.id ? 'bg-white shadow-sm text-indigo-600 font-medium ring-1 ring-slate-200' : 'text-slate-600 hover:bg-slate-100'}`}><span className="truncate">{doc.title}</span>{activeDocId === doc.id && (<div onClick={(e) => { e.stopPropagation(); deleteDoc(doc.id); }} className="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><X size={14} /></div>)}</button>))}</div>
        </div>
        <div className="flex-1 flex flex-col bg-white">
          {activeDoc ? (<><div className="h-14 border-b border-slate-100 flex items-center justify-between px-6 shrink-0"><div className="flex items-center gap-2 text-sm text-slate-400"><span>Última edição: Hoje</span></div><div>{isEditing ? <Button onClick={saveDoc} icon={Save} className="py-1.5 h-8 text-xs">Salvar</Button> : <Button onClick={() => setIsEditing(true)} variant="secondary" icon={Edit2} className="py-1.5 h-8 text-xs">Editar</Button>}</div></div><div className="flex-1 overflow-y-auto custom-scrollbar p-8 max-w-3xl mx-auto w-full">{isEditing ? (<div className="space-y-4"><input className="w-full text-3xl font-bold text-slate-800 placeholder-slate-300 border-none outline-none" placeholder="Título" value={editTitle} onChange={(e) => setEditTitle(e.target.value)} /><textarea className="w-full h-[calc(100vh-300px)] resize-none text-slate-600 leading-relaxed border-none outline-none text-base" placeholder="Escreva..." value={editContent} onChange={(e) => setEditContent(e.target.value)} /></div>) : (<div className="prose prose-slate max-w-none"><h1 className="text-3xl font-bold text-slate-800 mb-6">{activeDoc.title}</h1><div className="whitespace-pre-wrap text-slate-600 leading-relaxed">{activeDoc.content || <span className="text-slate-400 italic">Vazio.</span>}</div></div>)}</div></>) : (<div className="flex-1 flex flex-col items-center justify-center text-slate-300"><FileText size={64} className="mb-4 opacity-20" /><p>Selecione um documento.</p></div>)}
        </div>
      </div>
    );
  };

  // 8. TRANSFER MANAGER MODULE
  const TransferManager = () => {
    const [tab, setTab] = useState('board');
    const [successMsg, setSuccessMsg] = useState('');
    const [boardSrcProj, setBoardSrcProj] = useState('');
    const [boardIdToMove, setBoardIdToMove] = useState('');
    const [boardTargetProj, setBoardTargetProj] = useState('');
    const [cardSrcProj, setCardSrcProj] = useState('');
    const [cardSrcBoard, setCardSrcBoard] = useState('');
    const [cardIdToMove, setCardIdToMove] = useState('');
    const [cardTargetProj, setCardTargetProj] = useState('');
    const [cardTargetBoard, setCardTargetBoard] = useState('');
    const [projIdToTransfer, setProjIdToTransfer] = useState('');
    const [targetUser, setTargetUser] = useState('');

    const handleMoveBoard = () => {
      if (!boardSrcProj || !boardIdToMove || !boardTargetProj) return;
      const updatedProjects = [...projects];
      const srcPIndex = updatedProjects.findIndex(p => p.id === boardSrcProj);
      const targetPIndex = updatedProjects.findIndex(p => p.id === boardTargetProj);
      const boardIndex = updatedProjects[srcPIndex].boards.findIndex(b => b.id === boardIdToMove);
      const [boardToMove] = updatedProjects[srcPIndex].boards.splice(boardIndex, 1);
      updatedProjects[targetPIndex].boards.push(boardToMove);
      setProjects(updatedProjects);
      setSuccessMsg(`Board movido com sucesso!`);
      setBoardIdToMove('');
    };

    const handleMoveCard = () => {
       if (!cardSrcProj || !cardSrcBoard || !cardIdToMove || !cardTargetProj || !cardTargetBoard) return;
       const updatedProjects = [...projects];
       const srcP = updatedProjects.find(p => p.id === cardSrcProj);
       const srcB = srcP.boards.find(b => b.id === cardSrcBoard);
       const targetP = updatedProjects.find(p => p.id === cardTargetProj);
       const targetB = targetP.boards.find(b => b.id === cardTargetBoard);
       const cardIndex = srcB.cards.findIndex(c => c.id === cardIdToMove);
       const [cardToMove] = srcB.cards.splice(cardIndex, 1);
       cardToMove.columnId = targetB.columns[0].id;
       targetB.cards.push(cardToMove);
       setProjects(updatedProjects);
       setSuccessMsg(`Card transferido com sucesso!`);
       setCardIdToMove('');
    };

    const handleTransferProject = () => {
      if (!projIdToTransfer || !targetUser) return;
      const updatedProjects = projects.map(p => {
        if (p.id === projIdToTransfer) {
          const newMembers = p.members.includes(targetUser) ? p.members : [...p.members, targetUser];
          return { ...p, owner: targetUser, members: newMembers };
        }
        return p;
      });
      setProjects(updatedProjects);
      setSuccessMsg(`Projeto transferido.`);
      setProjIdToTransfer('');
      setTargetUser('');
    };

    useEffect(() => {
      if (successMsg) {
        const timer = setTimeout(() => setSuccessMsg(''), 3000);
        return () => clearTimeout(timer);
      }
    }, [successMsg]);

    return (
      <div className="p-8 max-w-5xl mx-auto animate-in fade-in">
        <h2 className="text-2xl font-bold text-slate-800 mb-2">Central de Transferências</h2>
        {successMsg && <div className="mb-6 p-4 bg-green-50 border border-green-200 text-green-700 rounded-lg flex items-center gap-2"><CheckCircle2 size={20} /> {successMsg}</div>}
        <div className="flex gap-2 mb-6 border-b border-slate-200">
           {['board', 'card', 'project'].map(t => (
             <button key={t} onClick={() => setTab(t)} className={`px-4 py-2 text-sm font-medium border-b-2 capitalize transition-colors ${tab === t ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-slate-500 hover:text-slate-700'}`}>{t === 'project' ? 'Propriedade' : `Mover ${t}`}</button>
           ))}
        </div>
        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-8">
           {tab === 'board' && (
             <div className="grid grid-cols-1 md:grid-cols-7 gap-6 items-center">
                <div className="md:col-span-3 space-y-4">
                   <h3 className="font-bold text-slate-700 flex items-center gap-2"><Box size={18}/> Origem</h3>
                   <div className="space-y-3">
                     <select className="w-full p-2 border rounded bg-slate-50" value={boardSrcProj} onChange={e => { setBoardSrcProj(e.target.value); setBoardIdToMove(''); }}><option value="">Projeto Atual</option>{projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}</select>
                     <select className="w-full p-2 border rounded bg-slate-50" value={boardIdToMove} onChange={e => setBoardIdToMove(e.target.value)} disabled={!boardSrcProj}><option value="">Selecione Board</option>{projects.find(p => p.id === boardSrcProj)?.boards.map(b => <option key={b.id} value={b.id}>{b.name}</option>)}</select>
                   </div>
                </div>
                <div className="flex justify-center md:col-span-1"><div className="bg-slate-100 p-2 rounded-full text-slate-400"><MoveRight size={24} /></div></div>
                <div className="md:col-span-3 space-y-4">
                   <h3 className="font-bold text-indigo-700 flex items-center gap-2"><FolderPlus size={18}/> Destino</h3>
                   <select className="w-full p-2 border border-indigo-200 rounded bg-indigo-50/30" value={boardTargetProj} onChange={e => setBoardTargetProj(e.target.value)}><option value="">Novo Projeto</option>{projects.filter(p => p.id !== boardSrcProj).map(p => <option key={p.id} value={p.id}>{p.name}</option>)}</select>
                   <Button onClick={handleMoveBoard} disabled={!boardIdToMove || !boardTargetProj} className="w-full mt-6">Confirmar</Button>
                </div>
             </div>
           )}
           {tab === 'card' && (
             <div className="grid grid-cols-1 md:grid-cols-7 gap-6 items-center">
                <div className="md:col-span-3 space-y-3">
                   <h3 className="font-bold text-slate-700 flex items-center gap-2"><Layout size={18}/> Origem</h3>
                   <select className="w-full p-2 border rounded bg-slate-50 text-sm" value={cardSrcProj} onChange={e => { setCardSrcProj(e.target.value); setCardSrcBoard(''); }}><option value="">Projeto</option>{projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}</select>
                   <select className="w-full p-2 border rounded bg-slate-50 text-sm" value={cardSrcBoard} onChange={e => { setCardSrcBoard(e.target.value); setCardIdToMove(''); }} disabled={!cardSrcProj}><option value="">Board</option>{projects.find(p => p.id === cardSrcProj)?.boards.map(b => <option key={b.id} value={b.id}>{b.name}</option>)}</select>
                   <select className="w-full p-2 border rounded bg-slate-50 text-sm" value={cardIdToMove} onChange={e => setCardIdToMove(e.target.value)} disabled={!cardSrcBoard}><option value="">Card</option>{projects.find(p => p.id === cardSrcProj)?.boards.find(b => b.id === cardSrcBoard)?.cards.map(c => <option key={c.id} value={c.id}>{c.title}</option>)}</select>
                </div>
                <div className="flex justify-center md:col-span-1"><ArrowRightLeft size={24} className="text-slate-300" /></div>
                <div className="md:col-span-3 space-y-3">
                   <h3 className="font-bold text-indigo-700 flex items-center gap-2"><FolderPlus size={18}/> Destino</h3>
                   <select className="w-full p-2 border border-indigo-200 rounded bg-indigo-50/30 text-sm" value={cardTargetProj} onChange={e => { setCardTargetProj(e.target.value); setCardTargetBoard(''); }}><option value="">Projeto</option>{projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}</select>
                   <select className="w-full p-2 border border-indigo-200 rounded bg-indigo-50/30 text-sm" value={cardTargetBoard} onChange={e => setCardTargetBoard(e.target.value)} disabled={!cardTargetProj}><option value="">Board</option>{projects.find(p => p.id === cardTargetProj)?.boards.map(b => <option key={b.id} value={b.id}>{b.name}</option>)}</select>
                   <Button onClick={handleMoveCard} disabled={!cardIdToMove || !cardTargetBoard} className="w-full mt-6">Mover Card</Button>
                </div>
             </div>
           )}
           {tab === 'project' && (
             <div className="max-w-xl mx-auto space-y-6">
                <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200 text-sm text-yellow-800 flex gap-3"><AlertCircle className="shrink-0" /><p>Ao transferir, você perde o status de 'Dono'.</p></div>
                <select className="w-full p-3 border rounded-lg bg-white" value={projIdToTransfer} onChange={e => setProjIdToTransfer(e.target.value)}><option value="">Selecione Projeto</option>{projects.filter(p => p.owner === 'Eu').map(p => <option key={p.id} value={p.id}>{p.name}</option>)}</select>
                <div className="relative"><UserCheck className="absolute left-3 top-3 text-slate-400" size={18}/><input className="w-full pl-10 p-3 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Novo dono (email)" value={targetUser} onChange={e => setTargetUser(e.target.value)}/></div>
                <Button onClick={handleTransferProject} disabled={!projIdToTransfer || !targetUser} className="w-full" size="lg">Transferir Propriedade</Button>
             </div>
           )}
        </div>
      </div>
    );
  };

  const ProjectCalendar = () => {
     // Calendário Global: Agrega cards de todos os projetos
     const allTasks = projects.flatMap(p => 
        p.boards.flatMap(b => 
           b.cards.filter(c => c.dueDate).map(c => ({
              ...c,
              projectName: p.name,
              boardName: b.name
           }))
        )
     );

     // Ordena por data
     allTasks.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

     return (
        <div className="h-full flex flex-col p-8 animate-in fade-in overflow-hidden">
           <div className="flex justify-between items-center mb-6 shrink-0">
              <div>
                 <h2 className="text-2xl font-bold text-slate-800">Calendário Global</h2>
                 <p className="text-slate-500">Visualizando entregas de todos os projetos.</p>
              </div>
              <Button variant="secondary" icon={Plus}>Novo Evento</Button>
           </div>
           
           <div className="flex-1 flex gap-6 overflow-hidden">
              {/* Grade do Calendário (Simulada) */}
              <div className="flex-1 bg-white border border-slate-200 rounded-xl p-6 flex flex-col">
                 <div className="grid grid-cols-7 gap-4 mb-4 border-b border-slate-100 pb-2">
                    {['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].map(d => <div key={d} className="text-center font-bold text-slate-400 text-sm">{d}</div>)}
                 </div>
                 <div className="flex-1 grid grid-cols-7 grid-rows-5 gap-1">
                    {/* Preenchendo com dias fictícios para visualização */}
                    {Array.from({length: 35}).map((_, i) => (
                       <div key={i} className="border border-slate-50 p-1 min-h-[60px] relative hover:bg-slate-50">
                          <span className="text-xs text-slate-400 absolute top-1 left-1">{i + 1 <= 30 ? i + 1 : ''}</span>
                       </div>
                    ))}
                 </div>
              </div>

              {/* Lista Lateral de Próximas Entregas */}
              <div className="w-80 bg-white border border-slate-200 rounded-xl p-6 overflow-y-auto custom-scrollbar">
                 <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Clock size={18}/> Próximas Entregas</h3>
                 <div className="space-y-3">
                    {allTasks.length > 0 ? allTasks.map(task => (
                       <div key={task.id} className="p-3 bg-slate-50 rounded-lg border border-slate-100 hover:border-indigo-200 transition-colors">
                          <div className="flex justify-between items-start mb-1">
                             <span className="text-xs font-bold bg-white px-2 py-0.5 rounded border text-slate-500">{new Date(task.dueDate).toLocaleDateString()}</span>
                             <Badge color={task.priority === 'alta' ? 'bg-red-100 text-red-600' : 'bg-slate-200 text-slate-600'}>{task.priority}</Badge>
                          </div>
                          <h4 className="font-bold text-slate-700 text-sm mb-1">{task.title}</h4>
                          <p className="text-xs text-slate-400">{task.projectName} • {task.boardName}</p>
                       </div>
                    )) : (
                       <p className="text-sm text-slate-400 text-center py-4">Nenhuma entrega próxima.</p>
                    )}
                 </div>
              </div>
           </div>
        </div>
     );
  };

  const ProjectChat = () => {
    // Se não tiver projeto, mostra o seletor integrado
    if (!activeProjectId) return <ProjectContextSelector onSelect={activateProjectContext} />;
    
    const [msgText, setMsgText] = useState('');
    const sendMsg = () => {
      if (!msgText.trim()) return;
      const newMsg = { id: Date.now(), user: 'Eu', text: msgText, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) };
      const updatedProjects = projects.map(p => {
        if (p.id === activeProjectId) { return { ...p, chat: [...p.chat, newMsg] }; }
        return p;
      });
      setProjects(updatedProjects);
      setMsgText('');
    };
    return (
      <div className="flex flex-col h-[calc(100vh-100px)] p-8 animate-in fade-in">
        <div className="flex items-center gap-3 mb-4">
           <h2 className="text-2xl font-bold text-slate-800">Chat: {activeProject.name}</h2>
           <button onClick={() => setActiveProjectId(null)} className="text-xs text-indigo-600 hover:underline flex items-center gap-1"><ArrowRightLeft size={12}/> Trocar Projeto</button>
        </div>
        <div className="flex-1 bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden flex flex-col">
          <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50/30">
            {activeProject.chat.map(msg => (
              <div key={msg.id} className={`flex flex-col ${msg.user === 'Eu' ? 'items-end' : 'items-start'}`}>
                <div className="flex items-baseline gap-2 mb-1">
                   <span className="text-xs font-bold text-slate-600">{msg.user}</span>
                   <span className="text-[10px] text-slate-400">{msg.time}</span>
                </div>
                <div className={`px-4 py-2 rounded-lg max-w-[80%] text-sm ${msg.user === 'Eu' ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white border border-slate-200 text-slate-700 rounded-tl-none'}`}>{msg.text}</div>
              </div>
            ))}
            {activeProject.chat.length === 0 && <div className="text-center text-slate-400 mt-10">Nenhuma mensagem ainda.</div>}
          </div>
          <div className="p-3 bg-white border-t border-slate-200 flex gap-2">
            <input className="flex-1 border border-slate-200 rounded-lg px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Digite sua mensagem..." value={msgText} onChange={e => setMsgText(e.target.value)} onKeyDown={e => e.key === 'Enter' && sendMsg()} />
            <Button onClick={sendMsg}>Enviar</Button>
          </div>
        </div>
      </div>
    );
  };

  const KanbanBoardView = () => (
      <div className="h-full flex flex-col animate-in fade-in p-6">
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2"><Layout size={20} className="text-indigo-600"/> {activeBoard.name}</h2>
          <Button variant="ghost" onClick={() => setActiveBoardId(null)}>Voltar aos Boards</Button>
        </div>
        <div className="flex-1 overflow-x-auto">
          <div className="flex gap-6 h-full min-w-max pb-4">
            {activeBoard.columns.map(col => (
              <div key={col.id} className={`w-80 flex flex-col rounded-xl border border-slate-200/60 h-full ${col.color}`}>
                <div className="p-4 font-bold text-slate-700">{col.title}</div>
                <div className="flex-1 p-3 space-y-3">
                    {activeBoard.cards.filter(c => c.columnId === col.id).map(card => (
                        <div key={card.id} className="bg-white p-3 rounded shadow-sm border border-slate-200 hover:shadow-md transition-shadow cursor-pointer">
                           <div className="flex justify-between items-start mb-2">
                              {card.priority === 'alta' && <div className="h-1.5 w-8 rounded-full bg-red-400"></div>}
                              {card.priority === 'media' && <div className="h-1.5 w-8 rounded-full bg-yellow-400"></div>}
                              {card.dueDate && <span className="text-[10px] text-slate-400">{new Date(card.dueDate).toLocaleDateString()}</span>}
                           </div>
                           <p className="text-sm font-medium text-slate-700">{card.title}</p>
                        </div>
                    ))}
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
  );

  const renderContent = () => {
    if (activeModule === 'profile') return <UserProfileView />;
    if (activeBoardId) return <KanbanBoardView />;
    
    switch (activeModule) {
      case 'dashboard': return activeProjectId ? <ProjectDashboard /> : <PlaceholderView title="Dashboard Global" icon={LayoutDashboard} description="Selecione um projeto." />;
      case 'notifications': return <PlaceholderView title="Notificações" icon={Bell} description="Alertas." />;
      case 'projects': return <ProjectsListView />;
      case 'kanban': return <KanbanHub />;
      case 'transfer': return <TransferManager />;
      case 'notes': return <NotesModule />;
      case 'calendar': return <ProjectCalendar />;
      case 'chat': return <ProjectChat />;
      case 'docs': return <ProjectDocs />;
      case 'settings': return <SettingsModule />;
      default: return <ProjectsListView />;
    }
  };

  const menuItems = [
    { id: 'dashboard', label: 'Dashboard', icon: LayoutDashboard },
    { id: 'notifications', label: 'Notificações', icon: Bell },
    { id: 'projects', label: 'Projetos', icon: Folder },
    { id: 'kanban', label: 'Kanban', icon: Layout },
    { id: 'transfer', label: 'Transferência', icon: ArrowRightLeft },
    { id: 'notes', label: 'Anotações', icon: StickyNote },
    { id: 'calendar', label: 'Calendário', icon: CalendarIcon },
    { id: 'chat', label: 'Chat', icon: MessageSquare },
    { id: 'docs', label: 'Documentação', icon: FileText },
    { id: 'settings', label: 'Configurações', icon: Settings },
  ];

  return (
    <div className="flex h-screen bg-slate-50 font-sans text-slate-800 overflow-hidden">
      <aside className="w-64 bg-white border-r border-slate-200 flex flex-col shrink-0 z-20">
        <div className="p-4 border-b border-slate-100 bg-slate-50/50 h-16 flex flex-col justify-center">
           {activeProject ? (
             <>
               <h2 className="font-bold text-sm text-slate-800 leading-tight truncate">{activeProject.name}</h2>
               <span className="text-[10px] uppercase font-bold text-indigo-600 truncate">{activeProject.department}</span>
             </>
           ) : (
             <h2 className="font-bold text-lg text-slate-800 flex items-center gap-2"><GripVertical size={20} className="text-indigo-600"/> Gestão Pro</h2>
           )}
        </div>
        <nav className="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-1">
          {menuItems.map(item => (
            <button key={item.id} onClick={() => navigateTo(item.id)} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors ${activeModule === item.id ? 'bg-indigo-50 text-indigo-700' : 'text-slate-600 hover:bg-slate-50 hover:text-indigo-600'}`}>
              <item.icon size={18} className={activeModule === item.id ? 'text-indigo-600' : 'text-slate-400'} />
              {item.label}
            </button>
          ))}
        </nav>
        <div className="p-4 border-t border-slate-100 bg-white">
          <button onClick={goToProfile} className={`flex items-center gap-3 w-full p-2 rounded-lg transition-colors group ${activeModule === 'profile' ? 'bg-indigo-50' : 'hover:bg-slate-50'}`}>
            <div className="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-sm">{user.name.charAt(0)}</div>
            <div className="text-left flex-1 overflow-hidden"><p className="text-sm font-medium text-slate-700 truncate">{user.name}</p><p className="text-xs text-slate-400 truncate">Ver Perfil</p></div>
            {activeProject && <div title="Sair do Projeto" onClick={(e) => { e.stopPropagation(); exitProject(); }} className="p-1 hover:bg-red-50 hover:text-red-500 rounded cursor-pointer text-slate-400"><LogOut size={14} /></div>}
          </button>
        </div>
      </aside>

      <main className="flex-1 flex flex-col min-w-0 bg-slate-50/50 relative">
        <header className="h-16 bg-white border-b border-slate-200 flex items-center px-6 sticky top-0 z-10 justify-between">
          <div className="flex items-center text-sm text-slate-500">
             <span className={`font-medium cursor-pointer hover:text-indigo-600 transition-colors ${!activeProject ? 'text-slate-800' : ''}`} onClick={() => navigateTo('projects')}>Home</span>
             {activeProject && <><ChevronRight size={14} className="mx-2" /><span className="font-medium text-slate-800">{activeProject.name}</span></>}
             <ChevronRight size={14} className="mx-2" />
             <span className="font-medium text-indigo-600 capitalize">{activeModule === 'profile' ? 'Meu Perfil' : activeBoardId ? activeBoard.name : menuItems.find(m => m.id === activeModule)?.label || 'Dashboard'}</span>
          </div>
          <div className="flex items-center gap-3">
             <div className="relative hidden md:block"><Search className="absolute left-3 top-2.5 text-slate-400" size={16} /><input placeholder="Buscar..." className="pl-9 pr-4 py-2 bg-slate-100 border-none rounded-full text-sm w-64 focus:ring-2 focus:ring-indigo-100 outline-none transition-all" /></div>
             <button className="p-2 text-slate-400 hover:text-indigo-600 bg-white hover:bg-slate-50 border border-slate-200 rounded-full transition-colors relative"><Bell size={18} /><span className="absolute top-1.5 right-2 w-2 h-2 bg-red-500 rounded-full border border-white"></span></button>
          </div>
        </header>
        <div className="flex-1 overflow-hidden relative"><div className="h-full overflow-y-auto custom-scrollbar">{renderContent()}</div></div>
      </main>

      <Modal isOpen={isBoardModalOpen} onClose={() => setIsBoardModalOpen(false)} title="Novo Quadro Kanban">
        <div className="space-y-4">
           <div><label className="block text-sm font-medium text-slate-700 mb-1">Nome</label><input className="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ex: Sprint 10..." value={newBoardName} onChange={e => setNewBoardName(e.target.value)} autoFocus /></div>
           <div>
             <label className="block text-sm font-medium text-slate-700 mb-1">Projeto Relacionado</label>
             {projects.length > 0 ? (
               <select className="w-full p-2 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 bg-white" value={selectedProjectForBoard} onChange={e => setSelectedProjectForBoard(e.target.value)}><option value="" disabled>Selecione...</option>{projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}</select>
             ) : <div className="p-3 bg-yellow-50 text-yellow-800 text-sm rounded-lg border border-yellow-200 mb-2">Crie um projeto antes.</div>}
           </div>
           <Button onClick={createBoard} className="w-full" disabled={!selectedProjectForBoard || !newBoardName.trim()}>Criar Board</Button>
           <div className="text-center pt-2 border-t border-slate-100 mt-2"><span className="text-xs text-slate-500">Ou:</span><button onClick={() => setIsProjectModalOpen(true)} className="text-indigo-600 text-sm font-bold hover:underline ml-1">Criar Novo Projeto</button></div>
        </div>
      </Modal>

      <Modal isOpen={isProjectModalOpen} onClose={() => setIsProjectModalOpen(false)} title="Novo Projeto">
          <div className="space-y-4">
             <input className="w-full p-2 border rounded" placeholder="Nome do Projeto" value={newProjectName} onChange={e => setNewProjectName(e.target.value)} />
             
             <div className="grid grid-cols-2 gap-3">
                 <div>
                     <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Empresa</label>
                     <select className="w-full p-2 border rounded bg-white text-sm" value={newProjectCompany} onChange={e => setNewProjectCompany(e.target.value)}>
                         <option value="">Selecione...</option>
                         {companies.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                     </select>
                 </div>
                 <div>
                     <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Grupo</label>
                     <select className="w-full p-2 border rounded bg-white text-sm" value={newProjectGroup} onChange={e => setNewProjectGroup(e.target.value)}>
                         <option value="">Selecione...</option>
                         {groups.map(g => <option key={g.id} value={g.id}>{g.name}</option>)}
                     </select>
                 </div>
             </div>

             <Button onClick={createProject} className="w-full" disabled={!newProjectName.trim()}>Criar Projeto</Button>
          </div>
      </Modal>
    </div>
  );
}